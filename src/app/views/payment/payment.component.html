<breadcrumb [title]="'Payment'" [titleLink]="'/payment'" />

<div class="row g-3">
  <!-- Left: Filters / Search -->
  <div class="col-12 col-lg-2">
    <div class="card border-0 shadow-sm sticky-top" style="top: 1rem">
      <div class="card-body p-4">
        <div class="align-items-center mb-3">
          <div class="btn-group ms-auto" role="group" aria-label="Shop Type">
            <input
              type="radio"
              class="btn-check"
              name="btnShopType"
              id="btnShopTypeGrooming"
              [(ngModel)]="selectedShopType"
              [value]="'GROOMING'"
              (ngModelChange)="onShopTypeChange($event)"
            />
            <label
              class="btn btn-outline-primary btn-sm"
              for="btnShopTypeGrooming"
              >Grooming</label
            >

            <input
              type="radio"
              class="btn-check"
              name="btnShopType"
              id="btnShopTypePetShop"
              [(ngModel)]="selectedShopType"
              [value]="'PET_SHOP'"
              (ngModelChange)="onShopTypeChange($event)"
            />
            <label
              class="btn btn-outline-primary btn-sm"
              for="btnShopTypePetShop"
              >Pet Shop</label
            >
          </div>
        </div>

        <!-- Customer -->
        <div class="mb-3">
          <label class="form-label">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</label>
          <ng-select
            [items]="customerList"
            bindLabel="label"
            bindValue="key"
            [searchable]="true"
            (change)="onCustomerChange($event)"
          >
            <ng-template ng-option-tmp let-item="item">
              <div class="option-content">{{ item.label }}</div>
            </ng-template>
          </ng-select>
        </div>

        <!-- Pet (only GROOMING) -->
        @if (selectedShopType === "GROOMING") {
          <div class="mb-3">
            <label class="form-label">‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á</label>
            <ng-select
              [(ngModel)]="petId"
              [items]="petList"
              bindLabel="label"
              bindValue="key"
              [searchable]="true"
              [searchFn]="customSearchFn"
              (change)="onPetChange($event)"
            >
              <ng-template ng-option-tmp let-item="item">
                <div class="option-content">{{ item.label }}</div>
              </ng-template>
            </ng-select>
          </div>
        }

        <!-- Tags -->
        <div class="mb-3">
          <div class="d-flex flex-wrap gap-2">
            @for (tag of tags; track tag.id) {
              <button
                type="button"
                class="btn btn-sm"
                [ngClass]="{
                  'btn-success': isSelected(tag.id),
                  'btn-outline-success': !isSelected(tag.id),
                }"
                (click)="toggleTag(tag.id)"
                [attr.aria-pressed]="isSelected(tag.id)"
              >
                {{ tag.name }}
              </button>
            }
          </div>
        </div>

        <!-- Search -->
        <div>
          <label class="form-label mb-1">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</label>
          <input
            id="table-filtering-search"
            class="form-control"
            placeholder="{{ 'search' | translate }}"
            type="text"
            [(ngModel)]="filter"
            (ngModelChange)="onSearch()"
          />
        </div>
      </div>
    </div>
  </div>

  <!-- Middle: Items Grid -->
  <div class="col-12 col-lg-6">
    <div class="card border-0 shadow-sm items-card">
      <div class="card-body p-4">
        <div class="items-scroll">
          @if (selectedShopType === "GROOMING") {
            <div class="row g-2">
              @for (item of groomingItems; track item.id) {
                <div class="col-12 col-md-4">
                  <div
                    class="card selectable-card h-100"
                    [ngClass]="{
                      'border-success shadow-sm': isItemSelected(
                        'G|' + item.id + '|' + petId
                      ),
                    }"
                    (click)="
                      toggleGroomingItemSelection(
                        $event,
                        'G|' + item.id + '|' + petId
                      )
                    "
                  >
                    <div class="card-body">
                      <div
                        class="d-flex align-items-start justify-content-between"
                      >
                        <h6 class="mb-1 text-truncate">{{ item.name }}</h6>
                        <span class="fw-semibold text-success">
                          {{ item.price | number: "1.2-2" }}
                        </span>
                      </div>
                      <div class="small text-muted text-truncate">
                        Note: {{ item.remark || "-" }}
                      </div>
                      <div class="small text-muted" *ngIf="petId">
                        #{{ petName(petId!) }}
                      </div>
                    </div>
                  </div>
                </div>
              }
            </div>
          } @else {
            <div class="row g-2">
              @for (item of petShopItems; track item.id) {
                <div class="col-12 col-md-4">
                  <div
                    class="card selectable-card h-100"
                    [ngClass]="{
                      'border-success shadow-sm': isItemSelected(
                        'P|' + item.id
                      ),
                      'disabled-card': !canAddPetShop(item),
                    }"
                    (click)="
                      canAddPetShop(item) &&
                        togglePetShopItemSelection($event, 'P|' + item.id)
                    "
                    [title]="
                      !canAddPetShop(item) ? getStockDisabledReason(item) : ''
                    "
                  >
                    <div class="card-body position-relative">
                      <span
                        *ngIf="!canAddPetShop(item)"
                        class="badge bg-secondary position-absolute top-0 start-0 m-2"
                      >
                        {{ item.stock <= 0 ? "‡∏´‡∏°‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å" : "‡∏Ñ‡∏£‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤" }}
                      </span>
                      @if (isItemSelected("P|" + item.id)) {
                        <button
                          class="btn btn-sm btn-outline-danger position-absolute top-1 end-0 m-4 z-2"
                          (click)="decreaseItemCount($event, 'P|' + item.id)"
                          title="‡∏•‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô"
                        >
                          ‚àí
                        </button>
                      }
                      <div
                        class="d-flex align-items-start justify-content-between"
                      >
                        <h6 class="mb-1 text-truncate">{{ item.name }}</h6>
                        <span class="fw-semibold text-success">
                          {{ item.price | number: "1.2-2" }}
                        </span>
                      </div>
                      <div
                        class="small text-muted text-truncate"
                        style="padding-right: 70px"
                      >
                        Note: {{ item.remark || "-" }}
                      </div>
                      <div class="small text-muted">
                        Stock: {{ item.stock }}
                      </div>
                    </div>
                  </div>
                </div>
              }
            </div>
          }
        </div>
        <!-- /items-scroll -->
      </div>
    </div>
  </div>

  <!-- RIGHT: Cart + Summary + Payment -->
  <div class="col-12 col-lg-4">
    <div class="card border-0 shadow-sm sticky-top" style="top: 1rem">
      <div
        class="card-header bg-dark text-white fw-bold d-flex justify-content-between align-items-center"
      >
        <span>‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤ & ‡∏™‡∏£‡∏∏‡∏õ‡∏ö‡∏¥‡∏•</span>
        <small class="text-white-50" *ngIf="isCalculateLoading">
          <span class="spinner-border spinner-border-sm me-1"></span
          >‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡∏ô‚Ä¶
        </small>
      </div>

      <div class="card-body p-0">
        <!-- CART -->
        <div
          class="table-responsive"
          style="max-height: 320px; overflow-y: auto"
        >
          <table class="table table-sm align-middle mb-0">
            <thead class="table-light">
              <tr class="small text-muted">
                <th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                <th class="text-end" style="width: 84px">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                <th class="text-end" style="width: 120px">‡∏£‡∏ß‡∏°</th>
                <th style="width: 64px"></th>
              </tr>
            </thead>
            <tbody>
              @for (item of currentCart; track item.key) {
                <tr>
                  <td>
                    {{ item.name }}
                    @if (item.type === "G") {
                      <small class="text-secondary ms-1"
                        >#{{ petName(item.petId!) }}</small
                      >
                    }
                  </td>
                  <td class="text-end">{{ item.quantity }}</td>
                  <td class="text-end">{{ item.total | number: "1.2-2" }}</td>
                  <td class="text-center">
                    <div class="d-flex justify-content-end gap-2">
                      @if (item.type === "P") {
                        @if (canIncreaseFromCart(item)) {
                          <button
                            class="btn btn-sm btn-outline-secondary p-0 px-2"
                            (click)="
                              togglePetShopItemSelection($event, item.key!)
                            "
                            aria-label="‡πÄ‡∏û‡∏¥‡πà‡∏°"
                          >
                            +
                          </button>
                        }
                      }
                      <button
                        class="btn btn-sm btn-outline-secondary p-0 px-2"
                        (click)="decreaseItemCount($event, item.key!)"
                        aria-label="‡∏•‡∏î"
                      >
                        ‚àí
                      </button>
                    </div>
                  </td>
                </tr>
              }
              @if (!currentCart.length) {
                <tr>
                  <td colspan="4" class="text-center text-muted small p-3">
                    ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>

        <!-- SUMMARY -->
        <div class="p-3 border-top summary">
          <div class="line muted">
            <span>‡∏£‡∏ß‡∏° (‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î)</span>
            <span class="fw-semibold">{{ cartTotal | number: "1.2-2" }}</span>
          </div>

          <div *ngIf="groupedPromotions?.length" class="mt-2">
            @for (p of groupedPromotions; track p.name) {
              <div class="discount">
                <span>‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î: {{ p.name }}</span>
                <span>‚àí {{ p.amount | number: "1.2-2" }}</span>
              </div>
            }
          </div>

          <div *ngIf="overallPromotion" class="discount">
            <span>‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î (‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°): {{ overallPromotion!.name }}</span>
            <span
              >‚àí {{ overallPromotion!.discountAmount | number: "1.2-2" }}</span
            >
          </div>

          <hr />

          <div class="line muted">
            <span>‡∏£‡∏ß‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</span>
            <span class="text-danger"
              >‚àí {{ discountTotal | number: "1.2-2" }}</span
            >
          </div>

          <div class="line total mt-1">
            <span>‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</span>
            <span class="value">{{
              totalAfterDiscount | number: "1.2-2"
            }}</span>
          </div>

          <div
            class="alert alert-warning mt-3 mb-0"
            *ngIf="warningPromotions?.length"
          >
            <ul class="mb-0 ps-3">
              @for (w of warningPromotions; track $index) {
                <li>{{ w }}</li>
              }
            </ul>
          </div>
        </div>

        <!-- PAYMENT -->
        <div class="p-3 border-top">
          <button
            class="btn btn-success w-100 mb-2"
            [disabled]="!currentCart.length"
            (click)="openCashModal(cashModal)"
          >
            <span *ngIf="!isCashLoading">üíµ ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</span>
            <span
              *ngIf="isCashLoading"
              class="spinner-border spinner-border-sm me-1"
            ></span>
            <span *ngIf="isCashLoading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</span>
          </button>
          <button
            class="btn btn-primary w-100"
            [disabled]="!currentCart.length || isQrLoading"
            (click)="openQrModal(qrModal)"
          >
            <ng-container *ngIf="!isQrLoading"
              >üì± ‡∏ä‡∏≥‡∏£‡∏∞‡∏î‡πâ‡∏ß‡∏¢ QR Code</ng-container
            >
            <ng-container *ngIf="isQrLoading">
              <span class="spinner-border spinner-border-sm me-1"></span>
              ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á QR‚Ä¶
            </ng-container>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- modal -->
<ng-template #cashModal let-modal>
  <div class="modal-header">
    <h5 class="modal-title">‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</h5>
    <button
      type="button"
      class="btn-close"
      aria-label="Close"
      (click)="cashModalClose(modal)"
    ></button>
  </div>

  <div class="modal-body">
    <p>
      ‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥: <strong>{{ totalAfterDiscount | number: "1.2-2" }}</strong> ‡∏ö‡∏≤‡∏ó
    </p>

    <div class="mb-3">
      <label class="form-label">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏à‡πà‡∏≤‡∏¢‡∏°‡∏≤ (‡∏ö‡∏≤‡∏ó)</label>
      <input
        #cashInput
        type="text"
        class="form-control text-end fs-4"
        [ngModel]="cashReceived | number: '1.2-2'"
        (ngModelChange)="onCashChange($event)"
        placeholder="0.00"
        readonly
      />
    </div>

    <!-- ‡πÅ‡∏õ‡πâ‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç -->
    <div class="keypad">
      <div class="row g-2">
        <div class="col-4" *ngFor="let key of [1, 2, 3, 4, 5, 6, 7, 8, 9]">
          <button class="btn btn-light w-100" (click)="appendNumber(key)">
            {{ key }}
          </button>
        </div>
        <div class="col-4">
          <button class="btn btn-warning w-100" (click)="clearInput()">
            ‡∏•‡∏ö
          </button>
        </div>
        <div class="col-4">
          <button class="btn btn-light w-100" (click)="appendNumber(0)">
            0
          </button>
        </div>
      </div>
    </div>

    <!-- ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏≠‡∏ô -->
    <div
      class="alert alert-info"
      *ngIf="cashChange !== null"
      style="margin-top: 10px"
    >
      ‡∏ó‡∏≠‡∏ô: <strong>{{ cashChange | number: "1.2-2" }}</strong> ‡∏ö‡∏≤‡∏ó
    </div>
  </div>

  <div class="modal-footer">
    <button class="btn btn-secondary" (click)="cashModalClose(modal)">
      ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
    </button>
    <button
      class="btn btn-success"
      [disabled]="+cashReceived < totalAfterDiscount"
      (click)="confirmPayment(modal, 'CASH_PAYMENT')"
    >
      ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
    </button>
  </div>
</ng-template>
<!-- QR Payment Modal -->

<ng-template #qrModal let-modal>
  <div class="modal-header">
    <h5 class="modal-title">‡∏ä‡∏≥‡∏£‡∏∞‡∏î‡πâ‡∏ß‡∏¢ QR Code</h5>
    <button type="button" class="btn-close" (click)="modal.dismiss()"></button>
  </div>

  <div class="modal-body text-center">
    <div class="mb-2 text-muted small" *ngIf="qr.invoiceNo">
      ‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå: <strong>{{ qr.invoiceNo }}</strong>
    </div>

    <div class="mb-3 fs-5">
      ‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥:
      <strong>{{ qr.amount ?? totalAfterDiscount | number: "1.2-2" }}</strong>
      ‡∏ö‡∏≤‡∏ó
    </div>

    <div *ngIf="qr.imageDataUrl; else loadingOrError">
      <img
        [src]="qr.imageDataUrl"
        alt="QR"
        width="240"
        height="240"
        class="border rounded"
      />
      <div class="small text-muted mt-2" *ngIf="qr.expiresAt">
        ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏: {{ qr.expiresAt | date: "dd/MM/yyyy HH:mm:ss" }}
      </div>
    </div>

    <ng-template #loadingOrError>
      <div class="py-4">
        <div *ngIf="qrError; else loading" class="text-danger">
          {{ qrError }}
        </div>
        <ng-template #loading>
          <span class="spinner-border"></span>
        </ng-template>
      </div>
    </ng-template>
  </div>

  <div class="modal-footer">
    <button class="btn btn-outline-secondary" (click)="modal.dismiss()">
      ‡∏õ‡∏¥‡∏î
    </button>
    <button
      class="btn btn-success"
      (click)="confirmPayment(modal, 'QR_PAYMENT')"
    >
      ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡∏ä‡∏≥‡∏£‡∏∞
    </button>
  </div>
</ng-template>

<!-- Receipt Modal -->
<ng-template #receiptModal let-modal>
  <div class="modal-header">
    <h5 class="modal-title">‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</h5>
    <button type="button" class="btn-close" (click)="modal.dismiss()"></button>
  </div>

  <div class="modal-body">
    <div id="receipt-area">
      <div class="d-flex justify-content-between mb-2">
        <div>
          <div class="fw-bold">‡∏£‡πâ‡∏≤‡∏ô Grooming & Pet Shop</div>
          <div class="small text-muted">‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏¢‡πà‡∏≠</div>
        </div>
        <div class="text-end">
          <div>
            ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: <strong>{{ receipt?.invoiceNo }}</strong>
          </div>
          <div>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: {{ receipt?.paidAt | date: "dd/MM/yyyy HH:mm" }}</div>
        </div>
      </div>
      <hr class="my-2" />

      <div class="mb-2" *ngIf="receipt?.customerName">
        ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: {{ receipt?.customerName }}
        <span class="text-muted" *ngIf="receipt?.customerPhone">
          ‚Ä¢ {{ receipt?.customerPhone }}
        </span>
      </div>

      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead class="table-light">
            <tr>
              <th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
              <th class="text-end">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
              <th class="text-end">‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
              <th class="text-end">‡∏£‡∏ß‡∏°</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let it of receipt?.items">
              <td>
                {{ it.name }}
                <small class="text-muted" *ngIf="it.petName"
                  >#{{ it.petName }}</small
                >
              </td>
              <td class="text-end">{{ it.quantity }}</td>
              <td class="text-end">{{ it.price | number: "1.2-2" }}</td>
              <td class="text-end">{{ it.total | number: "1.2-2" }}</td>
            </tr>
          </tbody>
          <tfoot>
            <tr>
              <td colspan="3" class="text-end">‡∏£‡∏ß‡∏° (‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î)</td>
              <td class="text-end">
                {{ receipt?.totalBeforeDiscount | number: "1.2-2" }}
              </td>
            </tr>
            <tr *ngIf="receipt?.totalDiscount && receipt?.totalDiscount > 0">
              <td colspan="3" class="text-end text-danger">‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</td>
              <td class="text-end text-danger">
                -{{ receipt?.totalDiscount | number: "1.2-2" }}
              </td>
            </tr>
            <tr class="fw-bold">
              <td colspan="3" class="text-end">‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</td>
              <td class="text-end">
                {{ receipt?.totalAfterDiscount | number: "1.2-2" }}
              </td>
            </tr>
            <tr>
              <td colspan="3" class="text-end">‡∏ä‡∏≥‡∏£‡∏∞‡πÇ‡∏î‡∏¢</td>
              <td class="text-end">{{ receipt?.paymentType }}</td>
            </tr>
          </tfoot>
        </table>
      </div>

      <div class="small text-center text-muted mt-2">
        ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ üê∂üê±
      </div>
    </div>
  </div>

  <div class="modal-footer">
    <button class="btn btn-outline-secondary" (click)="closeReceipt(modal)">
      ‡∏õ‡∏¥‡∏î
    </button>
    <button class="btn btn-primary" (click)="printReceipt()">‡∏û‡∏¥‡∏°‡∏û‡πå A4</button>
    <button class="btn btn-success" (click)="printReceiptSlip()">
      ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏™‡∏•‡∏¥‡∏õ 58mm
    </button>
  </div>
</ng-template>
