<breadcrumb [title]="'Payment'" [titleLink]="'/payment'" />

<div class="row">
  <div class="col-lg-7">
    <div class="card">
      <div class="card-header">
        <div class="d-flex align-items-center">
          <h5 class="card-title mb-0">POS</h5>
          <div
            class="btn-group ms-auto"
            role="group"
            aria-label="Basic radio toggle button group"
          >
            <input
              type="radio"
              class="btn-check"
              name="btnShopType"
              id="btnShopTypeGrooming"
              autocomplete="off"
              [(ngModel)]="selectedShopType"
              [value]="'GROOMING'"
              (ngModelChange)="onShopTypeChange($event)"
            />
            <label class="btn btn-outline-primary" for="btnShopTypeGrooming"
              >Grooming</label
            >

            <input
              type="radio"
              class="btn-check"
              name="btnShopType"
              id="btnShopTypePetShop"
              autocomplete="off"
              [(ngModel)]="selectedShopType"
              [value]="'PET_SHOP'"
              (ngModelChange)="onShopTypeChange($event)"
            />
            <label class="btn btn-outline-primary" for="btnShopTypePetShop"
              >Pet Shop</label
            >
          </div>
        </div>
      </div>

      <div class="card-body d-flex flex-column">
        <!-- Customer pet-->
        <div class="row">
          <div class="col-md-6 mb-3" style="margin-top: 2em">
            <h3 class="text-left"></h3>
            <label for="typeInput" class="form-label"
              >Customer {{ customerId }}</label
            >
            <ng-select
              [items]="customerList"
              bindLabel="label"
              bindValue="key"
              [searchable]="true"
              (change)="onCustomerChange($event)"
            >
              <ng-template ng-option-tmp let-item="item">
                <div class="option-content">
                  {{ item.label }}
                </div>
              </ng-template>
            </ng-select>
          </div>
          @if (selectedShopType === "GROOMING") {
            <div class="col-md-6 mb-3" style="margin-top: 2em">
              <h3 class="text-left"></h3>
              <label for="typeInput" class="form-label">Pet {{ petId }}</label>
              <ng-select
                [(ngModel)]="petId"
                [items]="petList"
                bindLabel="label"
                bindValue="key"
                [searchable]="true"
                [searchFn]="customSearchFn"
                (change)="onPetChange($event)"
              >
                <ng-template ng-option-tmp let-item="item">
                  <div class="option-content">
                    {{ item.label }}
                  </div>
                </ng-template>
              </ng-select>
            </div>
          }
        </div>
        <!-- tag item -->
        <div class="row mt-2">
          <div
            class="d-flex justify-content-between align-items-center flex-wrap w-100"
          >
            <!-- ‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢: ‡∏õ‡∏∏‡πà‡∏° -->
            <div class="d-flex flex-wrap gap-2 align-items-center">
              @for (tag of tags; track $index) {
                <button
                  type="button"
                  class="btn btn-sm"
                  [ngClass]="{
                    'btn-success': isSelected(tag.id),
                    'btn-outline-success': !isSelected(tag.id),
                  }"
                  (click)="toggleTag(tag.id)"
                >
                  {{ tag.name }}
                </button>
              }
            </div>

            <!-- ‡∏ù‡∏±‡πà‡∏á‡∏Ç‡∏ß‡∏≤: ‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ -->
            <div>
              <div class="col-xl-12">
                <input
                  id="table-filtering-search"
                  class="form-control"
                  placeholder="{{ 'search' | translate }}"
                  type="text"
                  [(ngModel)]="filter"
                  (ngModelChange)="onSearch()"
                />
              </div>
            </div>
          </div>
        </div>
        <div class="scrollable-items mt-3">
          <div class="row" style="margin-top: 1em; padding-right: 10px">
            @if (selectedShopType === "GROOMING") {
              @for (item of groomingItems; track item.id) {
                <div class="col-md-4 col-xl-4">
                  <div
                    class="card card-item selectable-card"
                    [ngClass]="{
                      selected: isItemSelected('G|' + item.id + '|' + petId),
                    }"
                    (click)="
                      toggleGroomingItemSelection(
                        $event,
                        'G|' + item.id + '|' + petId
                      )
                    "
                  >
                    <div class="card-body">
                      <div class="widget-first">
                        <div class="d-flex align-items-center mb-1">
                          <h3 class="mb-0 fs-16 text-dark">{{ item.name }}</h3>
                        </div>
                        <div class="align-items-center mt-1">
                          Note : {{ item.remark }}
                        </div>
                        <div
                          class="d-flex justify-content-between align-items-center mt-1"
                        >
                          <span class="text-muted fs-12"></span>
                          <span class="text-success fw-bold">
                            {{ item.price }}</span
                          >
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              }
            } @else if (selectedShopType === "PET_SHOP") {
              <div
                class="row"
                style="margin-top: 1em; max-height: 100vh; overflow-y: auto"
              >
                @for (item of petShopItems; track item.id) {
                  <div class="col-md-4 col-xl-4">
                    <div
                      class="card card-item selectable-card"
                      [ngClass]="{
                        selected: isItemSelected('P|' + item.id),
                      }"
                      (click)="
                        togglePetShopItemSelection($event, 'P|' + item.id)
                      "
                    >
                      <div class="card-body">
                        @if (isItemSelected("P|" + item.id)) {
                          <button
                            class="btn btn-sm btn-outline-danger position-absolute top-0 end-0 m-2 z-2"
                            (click)="decreaseItemCount($event, 'P|' + item.id)"
                            title="‡∏•‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô"
                          >
                            ‚àí
                          </button>
                        }
                        <div class="widget-first">
                          <div class="d-flex align-items-center mb-1">
                            <h3 class="mb-0 fs-16 text-dark">
                              {{ item.name }}
                            </h3>
                          </div>
                          <div class="align-items-center mt-1">
                            Note: {{ item.remark }}
                          </div>
                          <div
                            class="d-flex justify-content-between align-items-center mt-1"
                          >
                            <span class="text-muted fs-12"
                              >Stock : {{ item.stock }}</span
                            >
                            <span class="text-success fw-bold">
                              {{ item.price }}
                            </span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                }
              </div>
            }
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-lg-5">
    <div class="card shadow-sm border-0">
      <div class="card-header bg-light text-dark">üõí Current Cart</div>
      <div class="card-body">
        @if (currentCart.length) {
          <div
            #cartTable
            class="table-responsive"
            style="max-height: calc(10 * 48px); overflow-y: auto"
          >
            <table class="table align-middle mb-0 cart-table">
              <thead>
                <tr class="text-muted small">
                  <th style="text-align: center">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
                  <th style="text-align: center">‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                  <th style="text-align: center">‡∏£‡∏≤‡∏Ñ‡∏≤ / ‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
                  <th style="text-align: center">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                  <th style="text-align: center">‡∏£‡∏ß‡∏°</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                @for (item of currentCart; track $index) {
                  <tr class="border-top">
                    <td class="item-index" style="text-align: center">
                      {{ $index + 1 }}
                    </td>
                    <td>
                      ({{ item.type }}) {{ item.name }}
                      @if (item.type === "G") {
                        <small class="text-secondary ms-1"
                          >#{{ petName(item.petId!) }}</small
                        >
                      }
                    </td>
                    <td style="text-align: right">
                      {{ item.price }}
                    </td>
                    <td style="text-align: right">
                      {{ item.quantity }}
                    </td>
                    <td style="text-align: right">
                      {{ item.total | number: "1.2-2" }}
                    </td>
                    <td style="text-align: center">
                      <div class="d-flex justify-content-center gap-2">
                        @if (item.type === "P") {
                          <button
                            class="btn btn-sm btn-outline-secondary p-0 px-2"
                            (click)="
                              togglePetShopItemSelection($event, item.key!)
                            "
                          >
                            +
                          </button>
                        }
                        <button
                          class="btn btn-sm btn-outline-secondary p-0 px-2"
                          (click)="decreaseItemCount($event, item.key!)"
                        >
                          ‚àí
                        </button>
                      </div>
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
          <div
            class="d-flex justify-content-between align-items-center mt-2 p-3 bg-light rounded border shadow-sm"
          >
            <button
              class="btn btn-success"
              (click)="onCalculate()"
              [disabled]="isFinalizing || !currentCart.length"
            >
              <span *ngIf="!isFinalizing">‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î</span>
              <span
                *ngIf="isFinalizing"
                class="spinner-border spinner-border-sm me-1"
              ></span>
              <span *ngIf="isFinalizing">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô...</span>
            </button>

            <div class="text-muted fs-6">
              <ng-container *ngIf="isPreviewLoading">
                <span class="spinner-border spinner-border-sm me-1"></span>
                ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡∏ô...
              </ng-container>
            </div>
          </div>

          <!-- Summary / Invoice -->
          <div class="invoice card border-0 shadow-sm mt-4">
            <div class="card-body p-4">
              <!-- Header -->
              <div
                class="d-flex justify-content-between align-items-start mb-3"
              >
                <div>
                  <div class="fw-semibold fs-5">‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</div>
                  <div class="text-muted small">
                    ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà {{ now ? (now | date: "dd/MM/yyyy") : "-" }} ¬∑ ‡πÄ‡∏ß‡∏•‡∏≤
                    {{ now ? (now | date: "HH:mm:ss") : "-" }}
                  </div>
                  <div class="text-muted small">
                    ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:
                    <span class="text-dark">
                      {{
                        selectedCustomer?.label || selectedCustomer?.name || "-"
                      }}
                    </span>
                    <ng-container *ngIf="selectedCustomer?.phone">
                      ({{ selectedCustomer?.phone }})
                    </ng-container>
                  </div>
                </div>
                <div class="text-end">
                  <span class="badge invoice-badge">POS</span>
                </div>
              </div>

              <!-- Items -->
              <div class="table-responsive">
                <table class="table table-sm invoice-table mb-3">
                  <thead>
                    <tr>
                      <th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                      <th class="text-end">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                      <th class="text-end">‡∏£‡∏ß‡∏°</th>
                    </tr>
                  </thead>
                  <tbody>
                    @for (it of summaryItems; track it.key) {
                      <tr>
                        <td>
                          <div class="fw-500">{{ it.name }}</div>
                          <div
                            class="small text-muted"
                            *ngIf="isGroomingKey(it.key)"
                          >
                            #{{ petNameFromItem(it) }}
                          </div>
                        </td>
                        <td class="text-end">{{ it.quantity }}</td>
                        <td class="text-end">
                          {{ it.total | number: "1.2-2" }}
                        </td>
                      </tr>
                    }
                  </tbody>
                </table>
              </div>

              <!-- Totals -->
              <div class="invoice-line d-flex justify-content-between">
                <span class="text-muted">‡∏£‡∏ß‡∏° {{ itemCount }} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
                <span>{{ totalBeforeDiscount | number: "1.2-2" }}</span>
              </div>

              <!-- Promotions -->
              <div *ngIf="groupedPromotions?.length" class="mt-2">
                @for (p of groupedPromotions; track p.name) {
                  <div class="invoice-line d-flex justify-content-between">
                    <span class="text-muted">‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î: {{ p.name }}</span>
                    <span>‚àí {{ p.amount | number: "1.2-2" }}</span>
                  </div>
                }
              </div>

              <div
                *ngIf="overallPromotion"
                class="invoice-line d-flex justify-content-between"
              >
                <span class="text-muted"
                  >‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î (‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°): {{ overallPromotion?.name }}</span
                >
                <span
                  >‚àí
                  {{ overallPromotion?.discountAmount | number: "1.2-2" }}</span
                >
              </div>

              <hr class="my-3" />

              <div class="invoice-line d-flex justify-content-between">
                <span class="text-muted">‡∏£‡∏ß‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</span>
                <span class="text-danger"
                  >‚àí {{ discountTotal | number: "1.2-2" }}</span
                >
              </div>

              <div class="d-flex justify-content-between align-items-end mt-2">
                <div class="fw-semibold">‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</div>
                <div class="display-6 fw-bold text-success lh-1">
                  {{ totalAfterDiscount | number: "1.2-2" }}
                </div>
              </div>

              <!-- Warnings -->
              <div
                class="alert alert-warning mt-3 mb-0"
                *ngIf="warningPromotions?.length"
              >
                <ul class="mb-0 ps-3">
                  @for (w of warningPromotions; track $index) {
                    <li>{{ w }}</li>
                  }
                </ul>
              </div>
            </div>
          </div>
        } @else {
          <p class="text-center text-muted small">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</p>
        }
      </div>
    </div>
  </div>
</div>
